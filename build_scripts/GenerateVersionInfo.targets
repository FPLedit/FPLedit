<!--
  FPLedit Build Process
  Common build properties for all projects.
  (c) Manuel Huber 2020-2022
-->

<Project>
  
  <PropertyGroup>
    <!-- Include own build tool -->
    <CoreCompileDependsOn>GenerateVersionInfoTarget;$(CoreCompileDependsOn)</CoreCompileDependsOn>
  </PropertyGroup>

  <UsingTask TaskName="GenerateVersionInfo" TaskFactory="RoslynCodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll" >
    <ParameterGroup>
      <PVersionUpTo ParameterType="System.String" Required="true" />
      <PVersionFrom ParameterType="System.String" Required="true" />
      <DisplayVersion ParameterType="System.String" Required="true" />
      <EtoVersion ParameterType="System.String" Required="true" />
      <VersionSuffix ParameterType="System.String" Required="false" />
      <IsNonFinal ParameterType="System.Boolean" Required="false" />
      <GitRevision ParameterType="System.String" Required="false" />
      <BuildDate ParameterType="System.String" Required="true" />
      <Output ParameterType="System.String" Required="true" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System.IO" />
      <Code Type="Fragment" Language="cs">
        <![CDATA[
        var gr = string.IsNullOrEmpty(GitRevision) ? "null" : $"\"{GitRevision}\"";
        var code = @"#nullable enable
// <auto-generated>GenerateVersionInfo</auto-generated>
///<summary>Version information for bundled plugins and the FPLedit main application, generated automatically from assembly version attributes.</summary>
internal static class Vi
{
    ///<summary>For bundled plugins: Compatible up to (Current version without patch)</summary>
    public const string PUpTo = """ + PVersionUpTo + @""";
    ///<summary>For bundled plugins: Version of plugin (normally equals assembly major.minor.patch)</summary>
    public const string PVersion = """ + PVersionFrom + @""";
    ///<summary>For bundled plugins: Compatible from - normally equals assembly version</summary>
    public const string PFrom = """ + PVersionFrom + @""";
    
    ///<summary>Display version of the main FPLedit application.</summary>
    public const string DisplayVersion = """ + DisplayVersion + @""";
    ///<summary>Version suffix that should only be displayed (and not compared directly)</summary>
    public const string VersionSuffix = """ + VersionSuffix + @""";
    
    ///<summary>Version of the bundled Eto libraries (from NuGet)</summary>
    public const string EtoVersion = """ + EtoVersion + @""";
    
    ///<summary>Git revision that was used to build this version of FPLedit.</summary>
    public const string? GitRevision = " + gr + @";
    
    ///<summary>Build date string representation.</summary>
    public const string BuildDate = """ + BuildDate + @""";
    
    ///<summary>Specifies, if this is a final build (e.g. not a beta version of FPLedit.</summary>
    public const bool IsNonFinal = " + ((bool)IsNonFinal).ToString().ToLower() + @";
}";
        File.WriteAllText(Output, code);
]]>
      </Code>
    </Task>
  </UsingTask>
  <Target Name="GenerateVersionInfoTarget" DependsOnTargets="_GenerateVersionInfoTarget">
    <ItemGroup>
      <Compile Include="$(IntermediateOutputPath)VersionInfo.g.cs" />
    </ItemGroup>
  </Target>
  <Target Name="_GenerateVersionInfoTarget" Outputs="$(IntermediateOutputPath)VersionInfo.g.cs">
    <GenerateVersionInfo 
      PVersionUpTo="$([System.Version]::Parse($(VersionPrefix)).ToString(2))" 
      PVersionFrom="$([System.Version]::Parse($(VersionPrefix)).ToString(3))" 
      DisplayVersion="$(Version)"
      VersionSuffix="$(VersionSuffix)"
      IsNonFinal="$(IsNonFinalFPLeditBuild)"
      EtoVersion="$(EtoVersion)"
      GitRevision="$(GitRevision)"
      BuildDate="$([System.DateTime]::Now.ToString('G'))"
      Output="$(IntermediateOutputPath)VersionInfo.g.cs" />
  </Target>

</Project>